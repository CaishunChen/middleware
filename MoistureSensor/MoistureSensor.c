///////////////////////////////////////////////////////////////////////////////////////////////////
//                                      Includes Section
///////////////////////////////////////////////////////////////////////////////////////////////////

#include "fsl_common.h"
#include "ADC.h"
#include "MoistureSensor.h"

///////////////////////////////////////////////////////////////////////////////////////////////////
//                                   Defines & Macros Section
///////////////////////////////////////////////////////////////////////////////////////////////////

#define LINEAR_A_FACTOR_Q7 	(-6)

#define LINEAR_SLOPE_Q7		(24782)

///////////////////////////////////////////////////////////////////////////////////////////////////
//                                       Typedef Section
///////////////////////////////////////////////////////////////////////////////////////////////////


///////////////////////////////////////////////////////////////////////////////////////////////////
//                                  Function Prototypes Section
///////////////////////////////////////////////////////////////////////////////////////////////////


///////////////////////////////////////////////////////////////////////////////////////////////////
//                                   Global Constants Section
///////////////////////////////////////////////////////////////////////////////////////////////////


///////////////////////////////////////////////////////////////////////////////////////////////////
//                                   Static Constants Section
///////////////////////////////////////////////////////////////////////////////////////////////////


///////////////////////////////////////////////////////////////////////////////////////////////////
//                                   Global Variables Section
///////////////////////////////////////////////////////////////////////////////////////////////////


///////////////////////////////////////////////////////////////////////////////////////////////////
//                                   Static Variables Section
///////////////////////////////////////////////////////////////////////////////////////////////////


///////////////////////////////////////////////////////////////////////////////////////////////////
//                                      Functions Section
///////////////////////////////////////////////////////////////////////////////////////////////////

void MoistureSensor_Init(void)
{
	ADC_Init();
}

uint8_t MoistureSensor_GetReading(void)
{
	uint32_t AdcReading;
	int32_t Moistureixed;
	uint8_t MoisturePercentage;

	AdcReading = ADC_GetConversion(MOISTURE_SENSOR_CHANNEL);

	/* now change the reading to percentage */
	/* this process requires offline readings of the sensor */
	/* dry and totally wet to make the correct translation  */

	/* The linear conversion from 0% - 100% with the given numbers is 	*/
	/* f(x) = 0.47*X + 193.61											*/

	Moistureixed = ((LINEAR_A_FACTOR_Q7 * (AdcReading << 7)) >> 7) + LINEAR_SLOPE_Q7;

	MoisturePercentage = Moistureixed >> 7;

	if(MoisturePercentage > 100)
	{
		MoisturePercentage = 100;
	}

	return MoisturePercentage;
}
///////////////////////////////////////////////////////////////////////////////////////////////////
// EOF
///////////////////////////////////////////////////////////////////////////////////////////////////


